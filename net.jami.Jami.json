{
    "app-id": "net.jami.Jami",
	"runtime": "org.gnome.Platform",
	"runtime-version": "3.34",
	"sdk": "org.gnome.Sdk",
    "command": "start-jami.sh",
    "finish-args": [
		"--socket=x11",
		"--socket=wayland",
		"--socket=pulseaudio",
		"--share=network",
		"--device=all",
		"--share=ipc",
		"--talk-name=org.freedesktop.secrets",
		"--talk-name=org.freedesktop.Notifications",
		"--talk-name=org.gnome.SettingsDaemon.MediaKeys",
		"--talk-name=org.mate.SettingsDaemon",
		"--talk-name=org.gnome.ScreenSaver",
		"--talk-name=org.cinnamon.ScreenSaver",
		"--talk-name=org.freedesktop.ScreenSaver",
		"--talk-name=com.canonical.Unity.Session",
		"--talk-name=org.kde.StatusNotifierWatcher",
		"--talk-name=com.canonical.indicator.application",
		"--talk-name=org.gnome.evolution",
		"--filesystem=~/.local/share/jami",
		"--filesystem=~/.config/jami",
		"--filesystem=~/.cache/jami",
		"--filesystem=xdg-config/ring",
		"--filesystem=xdg-download",
		"--filesystem=xdg-music",
		"--filesystem=xdg-pictures",
		"--filesystem=xdg-videos",
		"--filesystem=xdg-documents",
		"--filesystem=xdg-run/dconf",
		"--filesystem=xdg-config/dconf",
		"--talk-name=ca.desrt.dconf",
		"--own-name=cx.ring.Ring",
		"--own-name=cx.ring.RingGnome",
		"--own-name=net.jami.Jami"
    ],
    "build-options": {
        "build-args": [
            "--share=network"
        ]
    },
    "modules": [
        {
            "name": "Jami",
            "buildsystem": "simple",
            "build-commands": [
				"mkdir -p /app/bin && mv start-jami.sh /app/bin/ && chmod +x /app/bin/start-jami.sh",
                "git -C daemon remote set-url origin https://review.jami.net/ring-daemon",
                "git -C lrc remote set-url origin https://review.jami.net/ring-lrc",
                "git -C client-gnome remote set-url origin https://review.jami.net/ring-client-gnome",
                "git submodule update --init -- daemon lrc client-gnome",
				"git submodule update --remote -- daemon lrc client-gnome",
				"mkdir -p daemon/contrib/native && cd daemon/contrib/native && ../bootstrap && make -j .gnutls .ffmpeg && cd ../../../",
                "export PATH=$PATH:/app/bin",
                "./make-ring.py --install --global-install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://review.jami.net/ring-project",
                    "branch": "release/201908"
                },
				{
					"type": "patch",
					"path": "patches/support-flatpak-platform.patch"
				},
				{
					"type": "patch",
					"path": "patches/gitmodules.patch"
				},
				{
					"type": "patch",
					"path": "patches/install-jami.patch"
				},
                {
                    "type": "file",
                    "path": "start-jami.sh"
				}
            ],
			"modules": [
				"io.qt.qt5-base.json",
				{
					"name": "dbus-cpp",
                    "buildsystem": "simple",
                    "build-commands": [
                        "./configure --disable-ecore --disable-glib --disable-tests --disable-examples --prefix=/app",
                        "make install"
                    ],
					"sources": [
						{
							"type": "archive",
							"url": "https://sourceforge.net/projects/dbus-cplusplus/files/dbus-c%2B%2B/0.9.0/libdbus-c%2B%2B-0.9.0.tar.gz/",
							"sha512": "7acebbb4254b2886cc0f05c5ddeeeac0b5863c5552d32249463b89380b0b95b8225c80bd98b8c7fcaada42ab770b5eff41b15390cd0d78bf1ee322ac6c2de319"
						},
                        {
                            "type": "patch",
                            "path": "patches/dbus-c++-threading.patch"
                        },
                        {
                            "type": "patch",
                            "path": "patches/dbus-c++-writechar.patch"
                        },
                        {
                            "type": "patch",
                            "path": "patches/dbus-c++-gcc4.7.patch"
                        }
					]
				},
				{
					"name": "qrencode",
					"buildsystem": "cmake-ninja",
					"sources": [
						{
							"type": "archive",
							"url": "https://fukuchi.org/works/qrencode/qrencode-4.0.2.tar.bz2",
							"sha512": "2429c7938e32eacbaf327c029c7745ba33259f879661a8b6470cc617c780daf5bd1d5689599151df62e84badd2568eccab6c12f157331e512ab24a3899e0f002"
						}
					]
				},
				{
					"name": "yasm",
					"buildsystem": "cmake-ninja",
					"sources": [
						{
							"type": "archive",
							"url": "https://download.handbrake.fr/handbrake/contrib/yasm-1.3.0.tar.gz",
							"sha256": "3dce6601b495f5b3d45b59f7d2492a340ee7e84b5beca17e48f862502bd5603f"
						}
					]
				}
			]
        }
    ]
}